<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDS-32 - Smart Energy Management</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* ==================== HEADER ==================== */
      header {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
        text-align: center;
      }

      header h1 {
        color: #667eea;
        font-size: 2.5em;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      header p {
        color: #666;
        font-size: 1.1em;
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        padding: 8px 15px;
        background: #10b981;
        color: white;
        border-radius: 20px;
        font-weight: bold;
      }

      .pulse-dot {
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }

      /* ==================== GRID LAYOUT ==================== */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .card h2 {
        font-size: 1.4em;
        color: #667eea;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-icon {
        font-size: 1.8em;
      }

      /* ==================== METRICS ==================== */
      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
      }

      .metric:last-child {
        border-bottom: none;
      }

      .metric-label {
        color: #666;
        font-size: 1em;
        font-weight: 500;
      }

      .metric-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #333;
      }

      .metric-unit {
        font-size: 0.7em;
        color: #999;
        margin-left: 5px;
      }

      /* ==================== STATUS INDICATORS ==================== */
      .status-indicator {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-on {
        background: #10b981;
        box-shadow: 0 0 10px #10b981;
      }

      .status-off {
        background: #ef4444;
      }

      /* ==================== BUTTONS ==================== */
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
      }

      button:active {
        transform: scale(0.95);
      }

      .btn-on {
        background: #10b981;
        color: white;
      }

      .btn-on:hover {
        background: #059669;
      }

      .btn-off {
        background: #ef4444;
        color: white;
      }

      .btn-off:hover {
        background: #dc2626;
      }

      .btn-auto {
        background: #3b82f6;
        color: white;
      }

      .btn-auto:hover {
        background: #2563eb;
      }

      /* ==================== CHARTS ==================== */
      .chart-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        height: 400px;
      }

      .chart-container h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.3em;
      }

      /* ==================== ALERTS ==================== */
      .alert {
        padding: 15px 20px;
        margin-bottom: 10px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideOutRight {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100px);
        }
      }

      .alert-warning {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        color: #92400e;
      }

      .alert-critical {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        color: #991b1b;
      }

      .alert-info {
        background: #dbeafe;
        border-left: 4px solid #3b82f6;
        color: #1e40af;
      }

      .alert-message {
        flex: 1;
      }

      .alert-time {
        font-size: 0.85em;
        opacity: 0.7;
        margin-top: 5px;
      }

      .btn-resolve {
        padding: 8px 15px;
        background: rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
      }

      .btn-resolve:hover {
        background: rgba(0, 0, 0, 0.2);
      }

      /* ==================== LOADING ==================== */
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ==================== TIMESTAMP ==================== */
      .timestamp {
        font-size: 0.85em;
        color: #999;
        margin-top: 10px;
        text-align: center;
      }

      /* ==================== RESPONSIVE ==================== */
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }

        header h1 {
          font-size: 1.8em;
        }

        .metric-value {
          font-size: 1.5em;
        }

        .chart-container {
          height: 300px;
        }
      }

      /* ==================== HIGHLIGHT ANIMATIONS ==================== */
      .highlight {
        animation: highlight 0.5s ease;
      }

      @keyframes highlight {
        0%,
        100% {
          background: transparent;
        }
        50% {
          background: rgba(102, 126, 234, 0.2);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ==================== HEADER ==================== -->
      <header>
        <h1>
          <span>‚ö°</span>
          PDS-32 - Gestion √ânerg√©tique Intelligente
          <span>‚ö°</span>
        </h1>
        <p>Monitoring & Optimisation en Temps R√©el</p>
        <div class="live-indicator">
          <span class="pulse-dot"></span>
          <span>LIVE</span>
        </div>
        <div class="timestamp" id="lastUpdate">Chargement...</div>
      </header>

      <!-- ==================== METRICS GRID ==================== -->
      <div class="grid">
        <!-- Consommation Actuelle -->
        <div class="card">
          <h2><span class="card-icon">‚ö°</span> Consommation Actuelle</h2>
          <div class="metric">
            <span class="metric-label">Puissance</span>
            <span class="metric-value" id="currentPower"
              >--<span class="metric-unit">W</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Courant</span>
            <span class="metric-value" id="currentCurrent"
              >--<span class="metric-unit">A</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">√ânergie Totale</span>
            <span class="metric-value" id="totalEnergy"
              >--<span class="metric-unit">kWh</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Co√ªt Actuel</span>
            <span class="metric-value" id="currentCost"
              >--<span class="metric-unit">TND</span></span
            >
          </div>
        </div>

        <!-- Capteurs Environnementaux -->
        <div class="card">
          <h2><span class="card-icon">üå°Ô∏è</span> Environnement</h2>
          <div class="metric">
            <span class="metric-label">Temp√©rature</span>
            <span class="metric-value" id="temperature"
              >--<span class="metric-unit">¬∞C</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Humidit√©</span>
            <span class="metric-value" id="humidity"
              >--<span class="metric-unit">%</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Luminosit√©</span>
            <span class="metric-value" id="lightLevel"
              >--<span class="metric-unit">%</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Pr√©sence</span>
            <span class="metric-value">
              <span class="status-indicator" id="presenceIndicator"></span>
              <span id="presenceText" style="font-size: 0.8em">--</span>
            </span>
          </div>
        </div>

        <!-- Contr√¥le des Actionneurs -->
        <div class="card">
          <h2><span class="card-icon">üîå</span> Contr√¥le √âquipements</h2>

          <div style="margin-bottom: 20px">
            <div class="metric">
              <span class="metric-label">Climatisation / Chauffage</span>
              <span>
                <span class="status-indicator" id="relay1Indicator"></span>
                <span id="relay1Status">--</span>
              </span>
            </div>
            <div class="button-group">
              <button class="btn-on" onclick="controlRelay('relay1_on')">
                ON
              </button>
              <button class="btn-off" onclick="controlRelay('relay1_off')">
                OFF
              </button>
            </div>
          </div>

          <div style="margin-bottom: 20px">
            <div class="metric">
              <span class="metric-label">√âclairage</span>
              <span>
                <span class="status-indicator" id="relay2Indicator"></span>
                <span id="relay2Status">--</span>
              </span>
            </div>
            <div class="button-group">
              <button class="btn-on" onclick="controlRelay('relay2_on')">
                ON
              </button>
              <button class="btn-off" onclick="controlRelay('relay2_off')">
                OFF
              </button>
            </div>
          </div>

          <div>
            <div class="metric">
              <span class="metric-label">Mode Automatique</span>
              <span id="autoModeStatus">--</span>
            </div>
            <div class="button-group">
              <button class="btn-auto" onclick="controlRelay('auto_on')">
                ACTIVER AUTO
              </button>
              <button class="btn-off" onclick="controlRelay('auto_off')">
                D√âSACTIVER AUTO
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== ANALYTICS ==================== -->
      <div class="grid">
        <div class="card">
          <h2><span class="card-icon">üìä</span> Analyse Consommation</h2>
          <div class="metric">
            <span class="metric-label">Aujourd'hui</span>
            <span class="metric-value" id="todayEnergy"
              >--<span class="metric-unit">kWh</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Co√ªt Aujourd'hui</span>
            <span class="metric-value" id="todayCost"
              >--<span class="metric-unit">TND</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Estimation Mensuelle</span>
            <span class="metric-value" id="monthlyEstimate"
              >--<span class="metric-unit">TND</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">√âconomies Potentielles</span>
            <span
              class="metric-value"
              style="color: #10b981"
              id="potentialSavings"
              >--<span class="metric-unit">TND</span></span
            >
          </div>
        </div>

        <div class="card">
          <h2><span class="card-icon">üìà</span> Statistiques</h2>
          <div class="metric">
            <span class="metric-label">Puissance Moyenne</span>
            <span class="metric-value" id="avgPower"
              >--<span class="metric-unit">W</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Pic de Consommation</span>
            <span class="metric-value" id="peakPower"
              >--<span class="metric-unit">W</span></span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Heure du Pic</span>
            <span class="metric-value" style="font-size: 1em" id="peakTime"
              >--</span
            >
          </div>
          <div class="metric">
            <span class="metric-label">Comparaison Hier</span>
            <span class="metric-value" id="comparison" style="font-size: 1em"
              >--</span
            >
          </div>
        </div>
      </div>

      <!-- ==================== GRAPHIQUES ==================== -->
      <div class="chart-container">
        <h2>üìà Consommation √ânerg√©tique (24h)</h2>
        <canvas id="powerChart"></canvas>
      </div>

      <div class="chart-container">
        <h2>üå°Ô∏è Temp√©rature & Humidit√© (24h)</h2>
        <canvas id="environmentChart"></canvas>
      </div>

      <!-- ==================== ALERTES ==================== -->
      <div class="card">
        <h2><span class="card-icon">üö®</span> Alertes R√©centes</h2>
        <div id="alertsContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Chargement des alertes...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
      // ==================== CONFIGURATION ====================
      const API_BASE = window.location.origin + "/api";
      let powerChart, environmentChart;

      // ==================== INITIALIZATION ====================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ Dashboard initializing...");
        initCharts();
        fetchAllData();

        // Auto-refresh every 5 seconds
        setInterval(fetchAllData, 5000);
      });

      // ==================== INITIALIZE CHARTS ====================
      function initCharts() {
        // Power Chart
        const powerCtx = document.getElementById("powerChart").getContext("2d");
        powerChart = new Chart(powerCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Puissance (W)",
                data: [],
                borderColor: "#667eea",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                fill: true,
                tension: 0.4,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Puissance (W)",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Temps",
                },
              },
            },
          },
        });

        // Environment Chart
        const envCtx = document
          .getElementById("environmentChart")
          .getContext("2d");
        environmentChart = new Chart(envCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Temp√©rature (¬∞C)",
                data: [],
                borderColor: "#ef4444",
                backgroundColor: "rgba(239, 68, 68, 0.1)",
                yAxisID: "y",
                tension: 0.4,
                borderWidth: 2,
              },
              {
                label: "Humidit√© (%)",
                data: [],
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                yAxisID: "y1",
                tension: 0.4,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
            },
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "Temp√©rature (¬∞C)",
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                title: {
                  display: true,
                  text: "Humidit√© (%)",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });

        console.log("‚úì Charts initialized");
      }

      // ==================== FETCH ALL DATA ====================
      async function fetchAllData() {
        try {
          await Promise.all([
            fetchCurrentEnergy(),
            fetchCurrentSensors(),
            fetchCurrentPresence(),
            fetchActuatorsStatus(),
            fetchAnalytics(),
            fetchEnergyHistory(),
            fetchAlerts(),
          ]);

          updateLastUpdateTime();
        } catch (error) {
          console.error("‚ùå Error fetching data:", error);
        }
      }

      // ==================== API CALLS ====================

      async function fetchCurrentEnergy() {
        try {
          const response = await fetch(`${API_BASE}/energy/current`);
          if (!response.ok) return;

          const data = await response.json();

          document.getElementById(
            "currentPower"
          ).innerHTML = `${data.power.toFixed(
            2
          )}<span class="metric-unit">W</span>`;
          document.getElementById(
            "currentCurrent"
          ).innerHTML = `${data.current.toFixed(
            2
          )}<span class="metric-unit">A</span>`;
          document.getElementById(
            "totalEnergy"
          ).innerHTML = `${data.energy_total.toFixed(
            3
          )}<span class="metric-unit">kWh</span>`;
          document.getElementById(
            "currentCost"
          ).innerHTML = `${data.cost.toFixed(
            3
          )}<span class="metric-unit">TND</span>`;

          highlightElement("currentPower");
        } catch (error) {
          console.error("Error fetching energy:", error);
        }
      }

      async function fetchCurrentSensors() {
        try {
          const response = await fetch(`${API_BASE}/sensors/current`);
          if (!response.ok) return;

          const data = await response.json();

          document.getElementById(
            "temperature"
          ).innerHTML = `${data.temperature.toFixed(
            1
          )}<span class="metric-unit">¬∞C</span>`;
          document.getElementById(
            "humidity"
          ).innerHTML = `${data.humidity.toFixed(
            1
          )}<span class="metric-unit">%</span>`;
          document.getElementById(
            "lightLevel"
          ).innerHTML = `${data.light_level}<span class="metric-unit">%</span>`;
        } catch (error) {
          console.error("Error fetching sensors:", error);
        }
      }

      async function fetchCurrentPresence() {
        try {
          const response = await fetch(`${API_BASE}/presence/current`);
          if (!response.ok) return;

          const data = await response.json();

          const indicator = document.getElementById("presenceIndicator");
          const text = document.getElementById("presenceText");

          if (data.presence) {
            indicator.className = "status-indicator status-on";
            text.textContent = "D√©tect√©e";
            text.style.color = "#10b981";
          } else {
            indicator.className = "status-indicator status-off";
            text.textContent = "Absente";
            text.style.color = "#ef4444";
          }
        } catch (error) {
          console.error("Error fetching presence:", error);
        }
      }

      async function fetchActuatorsStatus() {
        try {
          const response = await fetch(`${API_BASE}/actuators/status`);
          if (!response.ok) return;

          const data = await response.json();

          updateRelayStatus("relay1", data.relay1);
          updateRelayStatus("relay2", data.relay2);

          const autoStatus = document.getElementById("autoModeStatus");
          if (data.auto_mode) {
            autoStatus.innerHTML =
              '<span style="color: #10b981; font-weight: bold;">‚úì ACTIF</span>';
          } else {
            autoStatus.innerHTML =
              '<span style="color: #ef4444; font-weight: bold;">‚úó INACTIF</span>';
          }
        } catch (error) {
          console.error("Error fetching actuators:", error);
        }
      }

      function updateRelayStatus(relayId, state) {
        const indicator = document.getElementById(`${relayId}Indicator`);
        const status = document.getElementById(`${relayId}Status`);

        if (state) {
          indicator.className = "status-indicator status-on";
          status.innerHTML =
            '<span style="color: #10b981; font-weight: bold;">ON</span>';
        } else {
          indicator.className = "status-indicator status-off";
          status.innerHTML =
            '<span style="color: #ef4444; font-weight: bold;">OFF</span>';
        }
      }

      async function fetchAnalytics() {
        try {
          const response = await fetch(`${API_BASE}/analytics/consumption`);
          if (!response.ok) return;

          const data = await response.json();

          document.getElementById(
            "todayEnergy"
          ).innerHTML = `${data.today.energy.toFixed(
            3
          )}<span class="metric-unit">kWh</span>`;
          document.getElementById(
            "todayCost"
          ).innerHTML = `${data.today.cost.toFixed(
            3
          )}<span class="metric-unit">TND</span>`;
          document.getElementById(
            "monthlyEstimate"
          ).innerHTML = `${data.monthly_estimate.toFixed(
            2
          )}<span class="metric-unit">TND</span>`;
          document.getElementById(
            "potentialSavings"
          ).innerHTML = `${data.potential_savings.toFixed(
            3
          )}<span class="metric-unit">TND</span>`;

          document.getElementById(
            "avgPower"
          ).innerHTML = `${data.average_power.toFixed(
            2
          )}<span class="metric-unit">W</span>`;
          document.getElementById(
            "peakPower"
          ).innerHTML = `${data.peak.power.toFixed(
            2
          )}<span class="metric-unit">W</span>`;

          if (data.peak.time) {
            const time = new Date(data.peak.time).toLocaleTimeString("fr-FR", {
              hour: "2-digit",
              minute: "2-digit",
            });
            document.getElementById("peakTime").textContent = time;
          }

          // Comparison
          const diff = data.today.energy - data.yesterday.energy;
          const percentage =
            data.yesterday.energy > 0
              ? ((diff / data.yesterday.energy) * 100).toFixed(1)
              : 0;
          const comparisonEl = document.getElementById("comparison");

          if (diff > 0) {
            comparisonEl.innerHTML = `<span style="color: #ef4444;">+${percentage}%</span>`;
          } else {
            comparisonEl.innerHTML = `<span style="color: #10b981;">${percentage}%</span>`;
          }
        } catch (error) {
          console.error("Error fetching analytics:", error);
        }
      }

      async function fetchEnergyHistory() {
        try {
          const response = await fetch(`${API_BASE}/energy/history?hours=24`);
          if (!response.ok) return;

          const data = await response.json();

          if (data.length === 0) return;

          const labels = data.map((item) => {
            const date = new Date(item.timestamp);
            return date.toLocaleTimeString("fr-FR", {
              hour: "2-digit",
              minute: "2-digit",
            });
          });

          const powers = data.map((item) => item.power);

          powerChart.data.labels = labels;
          powerChart.data.datasets[0].data = powers;
          powerChart.update("none");
        } catch (error) {
          console.error("Error fetching history:", error);
        }
      }

      async function fetchAlerts() {
        try {
          const response = await fetch(`${API_BASE}/alerts`);
          if (!response.ok) return;

          const alerts = await response.json();

          const container = document.getElementById("alertsContainer");

          if (alerts.length === 0) {
            container.innerHTML =
              '<div class="alert alert-info">‚úì Aucune alerte active</div>';
            return;
          }

          container.innerHTML = "";
          alerts.slice(0, 5).forEach((alert) => {
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert alert-${alert.severity.toLowerCase()}`;
            const time = new Date(alert.timestamp).toLocaleString("fr-FR");

            alertDiv.innerHTML = `
                    <div class="alert-message">
                        <strong>${getAlertIcon(alert.severity)} ${
              alert.message
            }</strong>
                        <div class="alert-time">${time}</div>
                    </div>
                    ${
                      !alert.resolved
                        ? `<button class="btn-resolve" onclick="resolveAlert(${alert.id})">R√©soudre</button>`
                        : '<span style="color: #10b981; font-weight: bold;">‚úì R√©solu</span>'
                    }
                `;

            container.appendChild(alertDiv);
          });
        } catch (error) {
          console.error("Error fetching alerts:", error);
        }
      }

      function getAlertIcon(severity) {
        switch (severity.toUpperCase()) {
          case "CRITICAL":
            return "üî¥";
          case "WARNING":
            return "‚ö†Ô∏è";
          case "INFO":
            return "‚ÑπÔ∏è";
          default:
            return "üìã";
        }
      }

      // ==================== CONTROL FUNCTIONS ====================

      async function controlRelay(command) {
        try {
          const response = await fetch(`${API_BASE}/control/relay`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ command }),
          });

          if (!response.ok) {
            throw new Error("Command failed");
          }

          const result = await response.json();
          console.log("‚úì Command sent:", result);

          showNotification(
            `Commande "${command}" envoy√©e avec succ√®s`,
            "success"
          );

          // Update immediately
          setTimeout(fetchActuatorsStatus, 1000);
        } catch (error) {
          console.error("‚ùå Error sending command:", error);
          showNotification("Erreur lors de l'envoi de la commande", "error");
        }
      }

      async function resolveAlert(alertId) {
        try {
          await fetch(`${API_BASE}/alerts/${alertId}/resolve`, {
            method: "PUT",
          });

          fetchAlerts();
          showNotification("Alerte r√©solue", "success");
        } catch (error) {
          console.error("Error resolving alert:", error);
        }
      }

      // ==================== UTILITY FUNCTIONS ====================

      function updateLastUpdateTime() {
        const now = new Date().toLocaleTimeString("fr-FR");
        document.getElementById(
          "lastUpdate"
        ).textContent = `Derni√®re mise √† jour: ${now}`;
      }

      function highlightElement(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          element.closest(".metric").classList.add("highlight");
          setTimeout(() => {
            element.closest(".metric").classList.remove("highlight");
          }, 500);
        }
      }

      function showNotification(message, type) {
        // Create toast element
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: ${type === "success" ? "#10b981" : "#ef4444"};
    color: white;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    z-index: 9999;
    animation: slideInRight 0.3s ease;
  `;

        const icon = type === "success" ? "‚úì" : "‚úó";
        toast.textContent = `${icon} ${message}`;

        document.body.appendChild(toast);

        // Remove after 3 seconds
        setTimeout(() => {
          toast.style.animation = "slideOutRight 0.3s ease";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    </script>
  </body>
</html>
